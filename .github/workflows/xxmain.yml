name: Fast Code Base64 - Win 11 (Smart Timeout)

on:
  workflow_dispatch:

# ====================================================
# إعدادات الوقت المركزية (عدل الرقم هنا فقط)
# ====================================================
env:
  JOB_TIMEOUT_MINS: 30  # الوقت الكلي للجوب
  # سيتم حساب وقت الانتظار تلقائياً: 360 - 10 = 350 دقيقة

jobs:
  deployment:
    runs-on: windows-latest
    # نستخدم المتغير هنا تلقائياً
    timeout-minutes: ${{ fromJson(env.JOB_TIMEOUT_MINS) }}

    env:
      aa2: "XCDOOD"
      aa3: "Zxxz4444"
      KEY_CHOICE: "1"
      APP_BUNDLE_URL: "https://tinyurl.com/appk5214s"
      ZIP_URL: "https://tinyurl.com/filesdownlaodkkda45"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ... (نفس خطوات إعداد RDP والمستخدمين السابقة تماماً) ...
      - name: Setup RDP & Users
        shell: pwsh
        run: |
          Write-Host "==== 1. CONFIGURING RDP & FIREWALL ===="
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name SecurityLayer -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          
          Write-Host "==== 2. SETTING UP USERS ===="
          $User = $env:aa2
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          $current = $env:USERNAME
          Set-LocalUser -Name $current -Password $Secure
          if ($current -ne "runneradmin") {
              $r = Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue
              if ($r) { Set-LocalUser -Name "runneradmin" -Password $Secure }
          }
          $u = Get-LocalUser -Name $User -ErrorAction SilentlyContinue
          if (-not $u) {
              New-LocalUser -Name $User -Password $Secure -FullName $User -AccountNeverExpires
              Add-LocalGroupMember Administrators $User
              Add-LocalGroupMember "Remote Desktop Users" $User
          } else {
              Set-LocalUser -Name $User -Password $Secure
          }

      # ... (نفس خطوات التحميل والتثبيت السابقة تماماً) ...
      - name: Download Bundle & Install Tailscale
        shell: pwsh
        run: |
          Write-Host "==== 3. DOWNLOADING APP BUNDLE ===="
          $TempDir = Join-Path $env:TEMP 'AppBundle'
          New-Item -Path $TempDir -ItemType Directory -Force | Out-Null
          $BundleZip = Join-Path $TempDir 'bundle.zip'
          try { Invoke-WebRequest -Uri $env:APP_BUNDLE_URL -OutFile $BundleZip -UseBasicParsing -TimeoutSec 600 } catch { Write-Error "Failed to download App Bundle."; exit 1 }
          Write-Host "Extracting Bundle..."
          $ExtractDir = Join-Path $TempDir 'Extracted'
          Expand-Archive -Path $BundleZip -DestinationPath $ExtractDir -Force
          
          $KeyName = "key$($env:KEY_CHOICE).txt"
          $KeyFile = Get-ChildItem -Path $ExtractDir -Filter $KeyName -Recurse | Select-Object -First 1
          if (-not $KeyFile) { Write-Error "Key file not found!"; exit 1 }
          try {
              $Encoded = Get-Content $KeyFile.FullName -Raw
              $Bytes = [System.Convert]::FromBase64String($Encoded.Trim())
              $RealKey = [System.Text.Encoding]::UTF8.GetString($Bytes).Trim()
          } catch { Write-Error "Failed to decode key."; exit 1 }

          $TsInstaller = Get-ChildItem -Path $ExtractDir -Include "*tailscale*.msi","*tailscale*.exe" -Recurse | Select-Object -First 1
          if ($TsInstaller) {
              if ($TsInstaller.Extension -eq ".msi") { Start-Process msiexec.exe -ArgumentList '/i', $TsInstaller.FullName, '/quiet', '/norestart' -Wait }
              else { Start-Process $TsInstaller.FullName -ArgumentList '/quiet', '/norestart' -Wait }
          }
          $TsExe = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe'
          $HostName = "RDP-Win11-$env:GITHUB_RUN_NUMBER"
          Start-Process -FilePath $TsExe -ArgumentList "up --authkey=$RealKey --hostname=$HostName --timeout=20s" -Wait -NoNewWindow

      - name: Install Apps (Ordered)
        shell: pwsh
        run: |
          $ExtractDir = Join-Path $env:TEMP 'AppBundle\Extracted'
          $RustInstaller = Get-ChildItem -Path $ExtractDir -Filter "*rust*.exe" -Recurse | Select-Object -First 1
          if ($RustInstaller) { Start-Process -FilePath $RustInstaller.FullName -ArgumentList "--silent-install" -NoNewWindow; Start-Sleep -Seconds 5 }
          
          $PayloadZip = Join-Path $env:TEMP 'payload.zip'
          try {
              Invoke-WebRequest -Uri $env:ZIP_URL -OutFile $PayloadZip -UseBasicParsing -TimeoutSec 600
              $profiles = @($env:USERPROFILE); if (Test-Path "C:\Users\$env:aa2") { $profiles += "C:\Users\$env:aa2" }
              foreach ($p in $profiles) {
                  foreach ($loc in @(Join-Path $p 'Downloads', Join-Path $p 'Desktop')) { 
                      try { New-Item -ItemType Directory -Path $loc -Force | Out-Null; Expand-Archive -Path $PayloadZip -DestinationPath $loc -Force } catch {} 
                  }
              }
          } catch {}

          $NstInstaller = Get-ChildItem -Path $ExtractDir -Filter "*nst*.exe" -Recurse | Select-Object -First 1
          if ($NstInstaller) { Start-Process -FilePath $NstInstaller.FullName -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-", "/S" -NoNewWindow -Wait }

      # ====================================================
      # الخطوة 4: (معدلة) الحساب التلقائي + خاصية التراجع
      # ====================================================
      - name: Keep Session Alive (Smart Monitor)
        shell: pwsh
        run: |
          # 1. الحساب التلقائي (المتغير الكلي - 10 دقائق)
          $TotalMins = [int]$env:JOB_TIMEOUT_MINS
          $KeepAliveMinutes = $TotalMins - 10
          
          Write-Host "==== SESSION CONFIGURATION ===="
          Write-Host "Total Job Timeout: $TotalMins minutes"
          Write-Host "Active Session Duration: $KeepAliveMinutes minutes (Automatic 10 min buffer)"
          Write-Host "==============================="
          
          $StopFile = "C:\Users\Public\STOP_SIGNAL.txt"
          $sw = [Diagnostics.Stopwatch]::StartNew()
          $GracePeriodActive = $false
          $GraceStartTime = $null
          $GraceLimitMinutes = 10 

          while ($sw.Elapsed.TotalMinutes -lt $KeepAliveMinutes) {
            
            # فحص وجود ملف الإغلاق
            if (Test-Path $StopFile) {
                if (-not $GracePeriodActive) {
                    # بدء العد التنازلي للإغلاق
                    $GracePeriodActive = $true
                    $GraceStartTime = [Diagnostics.Stopwatch]::StartNew()
                    Write-Host "!!!! SHUTDOWN REQUEST DETECTED !!!!" -ForegroundColor Yellow
                    Write-Host "You have $GraceLimitMinutes minutes to cancel this by deleting '$StopFile'" -ForegroundColor Yellow
                }

                # حساب الوقت المتبقي في المهلة
                $GraceElapsed = $GraceStartTime.Elapsed.TotalMinutes
                $GraceLeft = [math]::Round($GraceLimitMinutes - $GraceElapsed, 1)

                if ($GraceElapsed -ge $GraceLimitMinutes) {
                    Write-Host "Grace period over. Closing session professionally..." -ForegroundColor Red
                    break # خروج من الحلقة لإنهاء الجلسة
                } else {
                    Write-Host "SHUTDOWN PENDING in $GraceLeft minutes... (Delete STOP_SIGNAL.txt to cancel)" -ForegroundColor DarkYellow
                }

            } else {
                # إذا كان الملف غير موجود
                if ($GracePeriodActive) {
                    # كان هناك عد تنازلي، لكن المستخدم حذف الملف!
                    $GracePeriodActive = $false
                    $GraceStartTime = $null
                    Write-Host "!!!! SHUTDOWN CANCELLED BY USER !!!!" -ForegroundColor Green
                    Write-Host "Resuming normal session..." -ForegroundColor Green
                }
                
                # الوضع الطبيعي
                $left = [math]::Round($KeepAliveMinutes - $sw.Elapsed.TotalMinutes)
                if ($sw.Elapsed.Seconds -lt 10) { 
                    Write-Host "Alive - $left minutes remaining..." 
                }
            }

            # الفحص كل 10 ثواني لضمان الاستجابة السريعة للتراجع
            Start-Sleep -Seconds 10
          }
          
          Write-Host "Session Time Finished."
